<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhareisBook | Biblioteca H√≠brida</title>
    
    <!-- √çcone -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>">

    <!-- Fontes: Merriweather (Liter√°ria) & Inter (Moderna) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Merriweather:ital,wght@0,300;0,700;0,900;1,400&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Cores e Planos */
            --bg-body: #f0f2f5;
            --paper: #ffffff;
            --ink: #1e293b;
            
            --gold: #d4af37; /* VIP/Admin */
            --blue: #2563eb; /* Commerce */
            --gray: #64748b; /* Padr√£o */
            
            --deep: #0f172a;
            --heart: #e11d48;

            --font-serif: 'Merriweather', serif;
            --font-sans: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-body); color: var(--ink); font-family: var(--font-sans); padding-bottom: 80px; }
        
        h1, h2, h3, .brand { font-family: var(--font-serif); }

        /* HEADER */
        header {
            background: var(--paper); border-bottom: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 50; padding: 1rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .brand { font-weight: 900; font-size: 1.4rem; color: var(--deep); display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--gold); }
        
        .btn-publish {
            background: var(--deep); color: var(--gold); border: none;
            padding: 8px 16px; border-radius: 4px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .btn-publish:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* HERO & INFO */
        .shelf-info { text-align: center; padding: 3rem 1rem; background: var(--deep); color: white; margin-bottom: 2rem; }
        .shelf-info h2 { color: var(--gold); margin-bottom: 10px; font-size: 2rem; }
        .shelf-info p { opacity: 0.8; max-width: 600px; margin: 0 auto; font-weight: 300; }

        /* GRID ESTANTE */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 5%; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem 1.5rem;
        }

        /* CARD DE LIVRO */
        .book {
            position: relative; perspective: 1000px; cursor: pointer;
            transition: transform 0.3s;
        }
        .book:hover { transform: translateY(-5px); }
        
        .cover-wrap {
            aspect-ratio: 2/3; background: #ddd; border-radius: 4px 8px 8px 4px;
            overflow: hidden; box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
            position: relative; margin-bottom: 10px;
        }
        .book img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Badges de Plano */
        .badge {
            position: absolute; top: 10px; right: 0; padding: 4px 10px;
            color: white; font-weight: bold; font-size: 0.7rem; text-transform: uppercase;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px 0 0 4px;
        }
        .b-permanent { background: var(--gold); color: black; }
        .b-vip { background: linear-gradient(45deg, #FFD700, #FDB931); color: black; border: 1px solid white; }
        .b-commerce { background: var(--blue); }
        .b-padrao { background: var(--gray); }
        
        /* Pendente (Visual Admin) */
        .book.pending { opacity: 0.7; }
        .book.pending .cover-wrap::after {
            content: 'AGUARDANDO APROVA√á√ÉO'; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(225, 29, 72, 0.8); color: white; display: flex;
            align-items: center; justify-content: center; font-weight: bold; text-align: center; font-size: 0.8rem; padding: 10px;
        }

        .book-title { font-weight: 700; line-height: 1.2; font-size: 1rem; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .book-author { font-size: 0.8rem; color: #64748b; font-style: italic; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.9); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 8px; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .step { display: none; } .step.active { display: block; }
        
        .form-group { margin-bottom: 12px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Sele√ß√£o de Planos */
        .plan-cards { display: flex; gap: 10px; margin-bottom: 15px; }
        .p-card { flex: 1; border: 1px solid #ddd; padding: 10px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s; opacity: 0.6; }
        .p-card.selected { border-color: var(--blue); background: #eff6ff; opacity: 1; transform: scale(1.05); font-weight: bold; }
        
        .btn-full { width: 100%; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-adm { background: var(--gold); color: black; margin-top: 5px; }
        .btn-del { background: var(--heart); margin-top: 5px; }

        /* Rodap√© */
        footer { text-align: center; padding: 2rem; color: #94a3b8; font-size: 0.8rem; margin-top: 4rem; border-top: 1px solid #e2e8f0; }
        .admin-link { cursor: pointer; color: #cbd5e1; margin-left: 5px; }
        .admin-bar { background: var(--deep); color: white; text-align: center; padding: 5px; font-size: 0.8rem; display: none; }
        
        /* Spinner */
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--gold); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- BARRA DE ADMIN -->
    <div id="adminBar" class="admin-bar">
        üîì MODO BIBLIOTEC√ÅRIO ATIVO | <span onclick="Admin.logout()" style="text-decoration:underline; cursor:pointer;">Sair</span>
    </div>

    <header>
        <div class="brand">
            <i class="fas fa-university fa-lg"></i>
            <div>Khareis<span>Book</span></div>
        </div>
        <button class="btn-publish" onclick="Modal.open()">
            <i class="fas fa-plus-circle"></i> Publicar Obra
        </button>
    </header>

    <div class="shelf-info">
        <h2>Acervo Vivo & H√≠brido</h2>
        <p>Explore a cole√ß√£o permanente ou divulgue suas pr√≥prias obras e artigos para a comunidade.</p>
        <!-- FILTROS -->
        <div style="margin-top: 15px;">
            <select id="filterSelect" onchange="App.load()" style="padding: 5px 10px; border-radius: 20px; border: none; font-family: var(--font-sans);">
                <option value="todos">Todas as Obras</option>
                <option value="permanent">üèõÔ∏è Acervo Permanente</option>
                <option value="comunidade">üë• Da Comunidade</option>
            </select>
        </div>
    </div>

    <div class="container">
        <div id="gridBooks" class="grid">
            <div class="spinner"></div>
        </div>
    </div>

    <footer>
        <p>"O conhecimento √© a √∫nica riqueza que cresce quando compartilhada."</p>
        <p style="margin-top:10px;">&copy; 2025 KhareisBook ‚Ä¢ Hybrid System V2 <span class="admin-link" onclick="Admin.prompt()">üîí</span></p>
    </footer>

    <!-- MODAL DE INTERA√á√ÉO -->
    <div id="mainModal" class="modal">
        <div class="modal-box">
            <span onclick="Modal.close()" style="position:absolute; right:15px; top:10px; font-size:1.5rem; cursor:pointer;">&times;</span>
            
            <!-- FORMUL√ÅRIO DE PUBLICA√á√ÉO -->
            <div id="formView" style="display:none;">
                <h3 style="margin-bottom:15px;">Publicar na Estante</h3>
                
                <div class="form-group">
                    <label style="font-weight:bold; font-size:0.9rem; display:block; margin-bottom:5px;">Escolha o Plano de Exposi√ß√£o:</label>
                    <div class="plan-cards">
                        <div class="p-card selected" onclick="Form.setPlan('vip', 10, this)">
                            <div style="color:var(--gold)">VIP</div>
                            <small>30 Dias</small><br>
                            <strong>R$ 10</strong>
                        </div>
                        <div class="p-card" onclick="Form.setPlan('commerce', 6, this)">
                            <div style="color:var(--blue)">COMM</div>
                            <small>15 Dias</small><br>
                            <strong>R$ 6</strong>
                        </div>
                        <div class="p-card" onclick="Form.setPlan('padrao', 3, this)">
                            <div style="color:var(--gray)">STD</div>
                            <small>7 Dias</small><br>
                            <strong>R$ 3</strong>
                        </div>
                    </div>
                    
                    <!-- Op√ß√£o Secreta de Admin -->
                    <div id="adminPlanOption" style="display:none; text-align:center; background:#eee; padding:5px; margin-bottom:10px; border-radius:4px;">
                        <label><input type="checkbox" id="chkPermanent" onchange="Form.togglePermanent()"> üèõÔ∏è Tornar Permanente (Gr√°tis/Acervo)</label>
                    </div>
                </div>

                <div class="form-group"><input id="inpTitle" class="form-control" placeholder="T√≠tulo da Obra / Artigo"></div>
                <div class="form-group"><input id="inpAuthor" class="form-control" placeholder="Nome do Autor"></div>
                <div class="form-group"><input id="inpLink" class="form-control" placeholder="Link do PDF/Arquivo (Drive/Dropbox)"></div>
                <div class="form-group"><textarea id="inpDesc" class="form-control" rows="3" placeholder="Sinopse ou Breve Descri√ß√£o..."></textarea></div>
                <div class="form-group"><label>Capa (Imagem Vertical)</label><input type="file" id="inpCover" accept="image/*" class="form-control"></div>

                <button class="btn-full" onclick="Form.submit()">Ir para Pagamento/Publica√ß√£o</button>
            </div>

            <!-- TELA DE PIX -->
            <div id="pixView" style="display:none; text-align:center;">
                <h3 style="color:var(--blue)">Confirma√ß√£o</h3>
                <p>Para ativar sua publica√ß√£o no plano <strong id="lblPlan"></strong>:</p>
                
                <div style="background:#f8f9fa; padding:15px; border:1px dashed #ccc; margin:15px 0; border-radius:8px;">
                    <p>Valor: <strong id="lblPrice" style="font-size:1.4rem;"></strong></p>
                    <p style="font-size:0.8rem; margin-top:5px;">Chave Pix (Celular):</p>
                    <p style="font-family:monospace; font-size:1.1rem;">61 999487649</p>
                </div>

                <button class="btn-full" style="background:#25D366;" onclick="Form.finishPix()">
                    <i class="fab fa-whatsapp"></i> Enviar Comprovante
                </button>
                <button class="btn-full" style="background:#ccc; color:#333;" onclick="Modal.close()">Cancelar</button>
            </div>

            <!-- DETALHES DO LIVRO (Leitura) -->
            <div id="bookView" style="display:none;">
                <div id="bookContent"></div>
            </div>

        </div>
    </div>

    <script>
        /**
         * SISTEMA H√çBRIDO V2
         */
        const Config = {
            dbUrl: "https://khareisbook-default-rtdb.firebaseio.com/library",
            pixKey: "61 999487649",
            adminPass: "khareis2025",
            
            plans: {
                permanent: { days: 99999, price: 0, label: "üèõÔ∏è Acervo Permanente" },
                vip:       { days: 30,    price: 10, label: "VIP (30 Dias)" },
                commerce:  { days: 15,    price: 6,  label: "Commerce (15 Dias)" },
                padrao:    { days: 7,     price: 3,  label: "Padr√£o (7 Dias)" }
            }
        };

        const Utils = {
            $: id => document.getElementById(id),
            formatMoney: v => parseFloat(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}),
            
            compress: file => new Promise(resolve => {
                if(!file) resolve(null);
                const r = new FileReader(); r.readAsDataURL(file);
                r.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const s = 300 / img.width; // Reduzir capa para 300px width
                        c.width = 300; c.height = img.height * s;
                        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                        resolve(c.toDataURL('image/jpeg', 0.7));
                    }
                }
            })
        };

        const Db = {
            list: async () => {
                try {
                    let r = await fetch(Config.dbUrl + ".json");
                    let d = await r.json();
                    return d ? Object.keys(d).map(k=>({...d[k], id:k})) : [];
                } catch(e){ return []; }
            },
            create: async (data) => {
                await fetch(Config.dbUrl + ".json", {method:'POST', body:JSON.stringify(data)});
            },
            updateStatus: async (id) => fetch(`${Config.dbUrl}/${id}.json`, {method:'PATCH', body:JSON.stringify({status:'active'})}),
            remove: async (id) => fetch(`${Config.dbUrl}/${id}.json`, {method:'DELETE'})
        };

        const Admin = {
            check: () => {
                if(sessionStorage.getItem('kb_adm')){
                    Utils.$('adminBar').style.display='block';
                    Utils.$('adminPlanOption').style.display='block'; // Mostra op√ß√£o permanente no form
                    return true;
                }
                return false;
            },
            prompt: () => {
                if(prompt("Senha do Bibliotec√°rio:") === Config.adminPass) {
                    sessionStorage.setItem('kb_adm','true');
                    location.reload();
                }
            },
            logout: () => { sessionStorage.removeItem('kb_adm'); location.reload(); },
            
            // Aprovar obra de usu√°rio
            approve: async (id) => {
                if(confirm("Confirmar Pix e Publicar obra?")) {
                    await Db.updateStatus(id);
                    App.load();
                }
            },
            delete: async (id) => {
                if(confirm("Remover permanentemente?")) {
                    await Db.remove(id);
                    App.load();
                }
            }
        };

        const App = {
            books: [],
            
            init: async () => {
                Admin.check();
                await App.load();
            },

            load: async () => {
                Utils.$('gridBooks').innerHTML = '<div class="spinner"></div>';
                
                let all = await Db.list();
                const now = Date.now();
                const isAdmin = Admin.check();
                const filter = Utils.$('filterSelect').value;

                // 1. FAXINA AUTOM√ÅTICA
                for(let b of all) {
                    const days = Config.plans[b.plan]?.days || 7;
                    const expireMs = days * 24 * 60 * 60 * 1000;
                    
                    // Se n√£o for permanente e j√° venceu -> DELETA
                    if(b.plan !== 'permanent' && (now - b.createdAt > expireMs)) {
                        Db.remove(b.id); 
                        continue;
                    }
                }

                // Recarrega lista limpa (simula√ß√£o visual, na real o ideal seria filtrar local)
                // Vamos apenas filtrar os deletados do array 'all'
                all = all.filter(b => b.plan === 'permanent' || (now - b.createdAt <= (Config.plans[b.plan]?.days * 86400000)));

                App.books = all; // Salva ref
                
                Utils.$('gridBooks').innerHTML = '';
                
                // 2. FILTRAR E RENDERIZAR
                let toShow = [];
                
                all.forEach(b => {
                    // Filtro de Admin (v√™ pendentes) vs P√∫blico (s√≥ ativos)
                    if(b.status === 'pending' && !isAdmin) return; 

                    // Filtros do Select
                    if(filter === 'permanent' && b.plan !== 'permanent') return;
                    if(filter === 'comunidade' && b.plan === 'permanent') return;

                    toShow.push(b);
                });

                if(toShow.length === 0) Utils.$('gridBooks').innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#888">Nenhuma obra encontrada.</p>';

                // ORDENAR: Permanente primeiro, depois VIPs
                toShow.sort((a,b) => {
                    const w = {permanent:4, vip:3, commerce:2, padrao:1};
                    return (w[b.plan] - w[a.plan]) || (b.createdAt - a.createdAt);
                });

                toShow.forEach(book => {
                    // Badge Visual
                    let badgeClass = 'b-padrao';
                    let badgeText = 'Padr√£o';
                    
                    if(book.plan === 'permanent') { badgeClass='b-permanent'; badgeText='üèõÔ∏è ACERVO'; }
                    else if(book.plan === 'vip') { badgeClass='b-vip'; badgeText='‚≠ê VIP'; }
                    else if(book.plan === 'commerce') { badgeClass='b-commerce'; badgeText='üöÄ COMMERCE'; }

                    const img = book.cover || 'https://placehold.co/200x300?text=Sem+Capa';
                    const isPending = book.status === 'pending';
                    const pendingClass = isPending ? 'pending' : '';

                    let action = `Modal.showBook('${book.id}')`;
                    // Se for admin, ao clicar num pendente, aprova
                    
                    const el = document.createElement('div');
                    el.className = `book ${pendingClass}`;
                    el.onclick = () => isPending && isAdmin ? null : Modal.showBook(book.id); 
                    
                    el.innerHTML = `
                        <div class="cover-wrap">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            <img src="${img}" loading="lazy">
                        </div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">${book.author}</div>
                        ${isPending && isAdmin ? `<button onclick="event.stopPropagation(); Admin.approve('${book.id}')" class="btn-full btn-adm">‚úÖ Aprovar</button>` : ''}
                        ${isAdmin ? `<button onclick="event.stopPropagation(); Admin.delete('${book.id}')" class="btn-full btn-del" style="font-size:0.7rem;padding:5px;">üóëÔ∏è</button>` : ''}
                    `;
                    Utils.$('gridBooks').appendChild(el);
                });
            }
        };

        const Form = {
            selPlan: 'vip',
            selPrice: 10,
            pendingData: null,

            setPlan: (plan, price, el) => {
                Form.selPlan = plan;
                Form.selPrice = price;
                document.querySelectorAll('.p-card').forEach(c=>c.classList.remove('selected'));
                if(el) el.classList.add('selected');
                Utils.$('chkPermanent').checked = false;
            },

            togglePermanent: () => {
                const chk = Utils.$('chkPermanent').checked;
                if(chk) {
                    Form.selPlan = 'permanent';
                    Form.selPrice = 0;
                    document.querySelectorAll('.p-card').forEach(c=>c.classList.remove('selected'));
                } else {
                    // Reset to Default VIP
                    Form.setPlan('vip', 10, document.querySelector('.p-card'));
                }
            },

            submit: async () => {
                const title = Utils.$('inpTitle').value;
                if(!title) return alert("T√≠tulo obrigat√≥rio!");

                const imgFile = Utils.$('inpCover').files[0];
                const imgData = await Utils.compress(imgFile);

                Form.pendingData = {
                    title: title,
                    author: Utils.$('inpAuthor').value || "An√¥nimo",
                    link: Utils.$('inpLink').value,
                    desc: Utils.$('inpDesc').value,
                    cover: imgData,
                    plan: Form.selPlan,
                    price: Form.selPrice,
                    createdAt: Date.now(),
                    status: (Form.selPlan === 'permanent') ? 'active' : 'pending' // Admin publica direto
                };

                // Se for Gr√°tis/Permanente (Admin), salva direto. Se for pago, cobra Pix.
                if(Form.selPrice === 0) {
                    await Db.create(Form.pendingData);
                    Modal.close();
                    App.load();
                    alert("Obra publicada no Acervo!");
                } else {
                    Utils.$('formView').style.display='none';
                    Utils.$('pixView').style.display='block';
                    Utils.$('lblPlan').innerText = Config.plans[Form.selPlan].label;
                    Utils.$('lblPrice').innerText = Utils.formatMoney(Form.selPrice);
                }
            },

            finishPix: async () => {
                // Salva como pendente
                await Db.create(Form.pendingData);
                const title = Form.pendingData.title;
                const price = Utils.formatMoney(Form.pendingData.price);
                
                // Manda pro Zap
                const msg = `Ol√°! Quero publicar a obra: "${title}" (${Form.pendingData.plan}). Valor: ${price}. Segue comprovante.`;
                window.open(`https://wa.me/55${Config.pixKey.replace(/ /g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                
                Modal.close();
                alert("Obra enviada para aprova√ß√£o!");
                location.reload(); // Para limpar o form
            }
        };

        const Modal = {
            open: () => {
                Utils.$('mainModal').style.display = 'flex';
                Utils.$('formView').style.display = 'block';
                Utils.$('pixView').style.display = 'none';
                Utils.$('bookView').style.display = 'none';
                // Reset basic inputs would go here
            },
            showBook: (id) => {
                const book = App.books.find(b => b.id === id);
                if(!book) return;

                Utils.$('mainModal').style.display = 'flex';
                Utils.$('formView').style.display = 'none';
                Utils.$('pixView').style.display = 'none';
                Utils.$('bookView').style.display = 'block';

                const btnTxt = book.link ? "‚¨áÔ∏è Acessar / Baixar" : "üí¨ Contatar Autor";
                const action = book.link 
                    ? `window.open('${book.link}','_blank')`
                    : `window.open('https://wa.me/55${Config.pixKey.replace(/ /g,'')}?text=Interesse na obra ${book.title}','_blank')`; // Fallback to admin contact

                Utils.$('bookContent').innerHTML = `
                    <div style="text-align:center">
                        <img src="${book.cover || ''}" style="max-height:200px; box-shadow:0 5px 15px rgba(0,0,0,0.3); margin-bottom:20px; border-radius:4px;">
                        <h2 style="margin-bottom:5px;">${book.title}</h2>
                        <p style="color:#666; font-style:italic;">Por ${book.author}</p>
                        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                        <p style="text-align:left; line-height:1.6; color:#333; margin-bottom:20px;">${book.desc}</p>
                        
                        <button onclick="${action}" class="btn-full" style="background:var(--deep); border-radius:30px;">
                            ${btnTxt}
                        </button>
                    </div>
                `;
            },
            close: () => Utils.$('mainModal').style.display = 'none'
        };

        // Iniciar
        window.addEventListener('load', App.init);

    </script>
</body>
</html>
